// Prisma Schema for Socio Chat Application
// PostgreSQL 16 with PostGIS 3.4+ for geospatial queries

generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["postgresqlExtensions"]
}

datasource db {
  provider   = "postgresql"
  url        = env("DATABASE_URL")
  extensions = [postgis, uuid_ossp(map: "uuid-ossp"), pg_trgm]
}

// =====================================================
// USERS TABLE
// =====================================================
model User {
  id            String    @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  username      String    @unique @db.VarChar(50)
  email         String?   @unique @db.VarChar(255)
  phone         String?   @unique @db.VarChar(20)
  passwordHash  String?   @map("password_hash") @db.VarChar(255)
  displayName   String?   @map("display_name") @db.VarChar(100)
  avatarUrl     String?   @map("avatar_url")
  bio           String?

  // Authentication
  authProvider   AuthProvider @default(EMAIL) @map("auth_provider")
  authProviderId String?      @map("auth_provider_id") @db.VarChar(255)
  isGuest        Boolean      @default(false) @map("is_guest")
  guestExpiresAt DateTime?    @map("guest_expires_at") @db.Timestamptz()

  // Location - stored as JSON until PostGIS raw queries are used
  currentLocation Json?    @map("current_location")
  locationUpdatedAt DateTime? @map("location_updated_at") @db.Timestamptz()
  locationPrecision LocationPrecision @default(APPROXIMATE) @map("location_precision")

  // Status
  isActive     Boolean @default(true) @map("is_active")
  isVerified   Boolean @default(false) @map("is_verified")
  shadowBanned Boolean @default(false) @map("shadow_banned")

  // Settings stored as JSON
  settings Json @default("{\"notifications\": true, \"locationSharing\": true, \"discoverable\": true}")

  // Timestamps
  createdAt    DateTime  @default(now()) @map("created_at") @db.Timestamptz()
  updatedAt    DateTime  @updatedAt @map("updated_at") @db.Timestamptz()
  lastActiveAt DateTime? @map("last_active_at") @db.Timestamptz()

  // Relations
  createdRooms   ChatRoom[]     @relation("RoomCreator")
  roomMemberships RoomMember[]
  sentMessages   Message[]      @relation("MessageSender")
  readReceipts   ReadReceipt[]
  presenceRecords UserPresence[]
  refreshTokens  RefreshToken[]

  @@index([username])
  @@index([email])
  @@index([phone])
  @@map("users")
}

enum AuthProvider {
  EMAIL
  GOOGLE
  APPLE
  PHONE

  @@map("auth_provider")
}

enum LocationPrecision {
  EXACT
  APPROXIMATE
  HIDDEN

  @@map("location_precision")
}

// =====================================================
// CHAT ROOMS TABLE
// =====================================================
model ChatRoom {
  id          String  @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  name        String  @db.VarChar(100)
  description String?
  avatarUrl   String? @map("avatar_url")

  creatorId String? @map("creator_id") @db.Uuid
  creator   User?   @relation("RoomCreator", fields: [creatorId], references: [id], onDelete: SetNull)

  // Location stored as JSON - use PostGIS raw queries for spatial operations
  location         Json
  computedLocation Json? @map("computed_location")
  locationGeohash  String? @map("location_geohash") @db.VarChar(12)

  // Room configuration
  radiusMeters Int     @default(5000) @map("radius_meters")
  isPublic     Boolean @default(true) @map("is_public")
  isActive     Boolean @default(true) @map("is_active")
  maxMembers   Int     @default(100) @map("max_members")

  // Tags for discovery
  tags String[] @default([])

  // Room settings stored as JSON
  settings Json @default("{\"allowMedia\": true, \"requireLocationCheck\": true, \"voiceEnabled\": true, \"videoEnabled\": true}")

  // Timestamps
  createdAt      DateTime @default(now()) @map("created_at") @db.Timestamptz()
  updatedAt      DateTime @updatedAt @map("updated_at") @db.Timestamptz()
  lastActivityAt DateTime @default(now()) @map("last_activity_at") @db.Timestamptz()

  // Relations
  members      RoomMember[]
  messages     Message[]
  readReceipts ReadReceipt[]

  @@index([creatorId])
  @@index([isActive, isPublic])
  @@index([tags], type: Gin)
  @@map("chat_rooms")
}

// =====================================================
// ROOM MEMBERS TABLE
// =====================================================
model RoomMember {
  id     String @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  roomId String @map("room_id") @db.Uuid
  userId String @map("user_id") @db.Uuid

  room ChatRoom @relation(fields: [roomId], references: [id], onDelete: Cascade)
  user User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Member location for weighted calculation - stored as JSON
  joinLocation Json? @map("join_location")

  // Role and permissions
  role MemberRole @default(MEMBER)

  // Activity weight for location calculation (0.0-2.0)
  activityWeight Decimal @default(1.0) @map("activity_weight") @db.Decimal(3, 2)

  // Preferences
  isMuted              Boolean @default(false) @map("is_muted")
  notificationsEnabled Boolean @default(true) @map("notifications_enabled")

  // Timestamps
  joinedAt   DateTime @default(now()) @map("joined_at") @db.Timestamptz()
  lastReadAt DateTime @default(now()) @map("last_read_at") @db.Timestamptz()

  @@unique([roomId, userId])
  @@index([roomId])
  @@index([userId])
  @@map("room_members")
}

enum MemberRole {
  CREATOR
  ADMIN
  MODERATOR
  MEMBER

  @@map("member_role")
}

// =====================================================
// MESSAGES TABLE
// =====================================================
model Message {
  id       String @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  roomId   String @map("room_id") @db.Uuid
  senderId String @map("sender_id") @db.Uuid

  room   ChatRoom @relation(fields: [roomId], references: [id], onDelete: Cascade)
  sender User     @relation("MessageSender", fields: [senderId], references: [id], onDelete: Cascade)

  // Content
  content     String
  contentType ContentType @default(TEXT) @map("content_type")

  // Metadata for rich content (stored as JSON)
  metadata Json @default("{}")

  // Threading
  replyToId String?  @map("reply_to_id") @db.Uuid
  replyTo   Message? @relation("MessageReplies", fields: [replyToId], references: [id], onDelete: SetNull)
  replies   Message[] @relation("MessageReplies")

  // Status
  isEdited  Boolean @default(false) @map("is_edited")
  isDeleted Boolean @default(false) @map("is_deleted")

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz()
  updatedAt DateTime @updatedAt @map("updated_at") @db.Timestamptz()

  @@index([roomId, createdAt(sort: Desc)])
  @@index([senderId, createdAt(sort: Desc)])
  @@map("messages")
}

enum ContentType {
  TEXT
  IMAGE
  VIDEO
  AUDIO
  FILE
  LOCATION

  @@map("content_type")
}

// =====================================================
// READ RECEIPTS TABLE
// =====================================================
model ReadReceipt {
  roomId            String   @map("room_id") @db.Uuid
  userId            String   @map("user_id") @db.Uuid
  lastReadMessageId String?  @map("last_read_message_id") @db.Uuid
  lastReadAt        DateTime @default(now()) @map("last_read_at") @db.Timestamptz()

  room ChatRoom @relation(fields: [roomId], references: [id], onDelete: Cascade)
  user User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@id([roomId, userId])
  @@map("read_receipts")
}

// =====================================================
// USER PRESENCE TABLE
// =====================================================
model UserPresence {
  id        String         @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  userId    String         @map("user_id") @db.Uuid
  status    PresenceStatus @default(OFFLINE)
  socketId  String?        @map("socket_id") @db.VarChar(100)
  deviceId  String?        @map("device_id") @db.VarChar(100)

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Timestamps
  lastSeenAt DateTime @default(now()) @map("last_seen_at") @db.Timestamptz()
  createdAt  DateTime @default(now()) @map("created_at") @db.Timestamptz()
  updatedAt  DateTime @updatedAt @map("updated_at") @db.Timestamptz()

  @@unique([userId, deviceId])
  @@index([userId])
  @@index([status])
  @@map("user_presence")
}

enum PresenceStatus {
  ONLINE
  AWAY
  BUSY
  OFFLINE

  @@map("presence_status")
}

// =====================================================
// REFRESH TOKENS TABLE (for JWT token rotation)
// =====================================================
model RefreshToken {
  id        String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  userId    String   @map("user_id") @db.Uuid
  token     String   @unique @db.VarChar(500)
  family    String   @db.VarChar(100) // Token family for rotation detection
  deviceId  String?  @map("device_id") @db.VarChar(100)
  expiresAt DateTime @map("expires_at") @db.Timestamptz()
  isRevoked Boolean  @default(false) @map("is_revoked")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz()

  @@index([userId])
  @@index([token])
  @@index([family])
  @@map("refresh_tokens")
}
